# 処理フロー設計書

## 1. フロー一覧

| フロー | トリガー | 概要 |
|--------|----------|------|
| 地域設定 | ユーザーのLINEメッセージ | 市区町村名を受け取り、緯度経度を取得して保存 |
| 天気配信 | EventBridge（毎日9:00） | 全ユーザーに天気情報を配信 |
| 設定確認 | ユーザーのLINEメッセージ | 現在の設定内容を返信 |

## 2. 地域設定フロー

### 2.1 シーケンス図

```
ユーザー
   │
   │ "渋谷区"
   ▼
LINE Platform
   │
   │ Webhook
   ▼
API Gateway ──► Lambda (Webhook)
                    │
                    ├─► Geocoding API（緯度経度取得）
                    │       │
                    │       ├─ 成功 ─► DynamoDB（保存）
                    │       │              │
                    │       │              ▼
                    │       │         LINE Reply
                    │       │         「渋谷区の天気をお届けします」
                    │       │
                    │       └─ 失敗 ─► LINE Reply
                    │                  「地名が見つかりません」
```

### 2.2 処理ステップ

1. LINE Webhook受信・署名検証
2. メッセージから市区町村名を抽出
3. Geocoding APIで緯度経度を取得
4. 成功時: DynamoDBに保存 → 確認メッセージ返信
5. 失敗時: エラーメッセージ返信

## 3. 天気配信フロー

### 3.1 シーケンス図

```
EventBridge (9:00 JST)
   │
   ▼
Lambda (配信処理)
   │
   ├─► DynamoDB（全ユーザー取得）
   │
   ├─► One Call API（天気取得）
   │       │
   │       ▼
   │   実質天気算出
   │   ・9:00〜23:00の最高/最低気温
   │   ・降水確率の最大値
   │
   └─► LINE Push Message（各ユーザーへ配信）
```

### 3.2 処理ステップ

1. EventBridgeにより9:00（JST）にトリガー
2. DynamoDBから全ユーザーを取得
3. 緯度経度でグルーピング（API呼び出し最適化）
4. One Call APIで天気情報を取得
5. 実質天気を算出
6. 各ユーザーにPush Messageで配信

### 3.3 配信メッセージ形式

```
【{cityName}の天気】
最高気温: {maxTemp}℃
最低気温: {minTemp}℃
降水確率: {pop}%
```

## 4. 設定確認フロー

### 4.1 シーケンス図

```
ユーザー
   │
   │ "設定確認"
   ▼
LINE Platform ──► API Gateway ──► Lambda (Webhook)
                                      │
                                      ├─► DynamoDB（ユーザー情報取得）
                                      │
                                      └─► LINE Reply
                                          ・設定あり: 「現在の設定: 渋谷区」
                                          ・設定なし: 「地域が設定されていません」
```

### 4.2 設定確認コマンド

以下のメッセージを設定確認として認識:
- `設定確認`
- `確認`
- `設定`
