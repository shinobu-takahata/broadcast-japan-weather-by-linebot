# 要求仕様書

## 1. 概要

地域設定フローのビジネスロジックを実装する。ユーザーがLINEで市区町村名を送信し、システムが緯度経度を取得してDynamoDBに保存し、確認メッセージを返信する一連の処理を実現する。

## 2. ユーザーストーリー

### US-001: 地域設定
```
ユーザーとして、
LINE BOTに市区町村名（例: "渋谷区"）を送信して通知してほしい地域を設定したい。
なぜなら、自分が知りたい地域の天気情報だけを受け取りたいから。
```

### US-002: 設定成功時のフィードバック
```
ユーザーとして、
地域設定が成功したときに確認メッセージを受け取りたい。
なぜなら、正しく設定されたことを確認したいから。
```

### US-003: 設定失敗時のフィードバック
```
ユーザーとして、
無効な地域名を入力したときにエラーメッセージと正しい入力方法の案内を受け取りたい。
なぜなら、どうすれば正しく設定できるかを知りたいから。
```

## 3. 機能要件

### 3.1 地域設定フロー

#### 3.1.1 入力
- ユーザーがLINE BOTに市区町村名をテキストメッセージで送信
- 例: "渋谷区"、"新宿区"、"横浜市"

#### 3.1.2 処理フロー
1. LINE Webhookリクエストを受信
2. リクエスト署名を検証（X-Line-Signature）
3. メッセージから市区町村名を抽出
4. OpenWeatherMap Geocoding APIで緯度経度を取得
5. 取得成功時:
   - DynamoDBのUsersテーブルに保存（userId, lat, lon, cityName, createdAt, updatedAt）
   - LINE Reply Messageで確認メッセージを返信
6. 取得失敗時:
   - LINE Reply Messageでエラーメッセージを返信

#### 3.1.3 出力
- 成功時の返信メッセージ例:
  ```
  {cityName}の天気をお届けします
  ```
- 失敗時の返信メッセージ例:
  ```
  申し訳ございません。「{入力された地名}」が見つかりませんでした。

  正しい市区町村名を入力してください。
  例: 渋谷区、新宿区、横浜市
  ```

### 3.2 データ保存仕様

#### 3.2.1 DynamoDB Usersテーブル
- **userId** (String): LINE User ID（Primary Key）
- **lat** (Number): 緯度
- **lon** (Number): 経度
- **cityName** (String): 市区町村名（表示用）
- **createdAt** (String): 登録日時（ISO 8601形式）
- **updatedAt** (String): 更新日時（ISO 8601形式）

#### 3.2.2 上書き更新
- 既に設定済みのユーザーが再度地域を設定した場合、データを上書き更新する
- updatedAtフィールドを現在時刻に更新する

### 3.3 エラーハンドリング

#### 3.3.1 署名検証エラー
- X-Line-Signatureヘッダが不正な場合、401 Unauthorizedを返す
- ログに警告を出力

#### 3.3.2 Geocoding APIエラー
- 地名が見つからない場合、ユーザーにエラーメッセージを返信
- APIタイムアウト・ネットワークエラーの場合、3回までリトライ（指数バックオフ: 1秒、2秒、4秒）
- リトライ失敗時、ユーザーにエラーメッセージを返信

#### 3.3.3 DynamoDBエラー
- 保存失敗時、3回までリトライ（指数バックオフ）
- リトライ失敗時、ユーザーにエラーメッセージを返信
- CloudWatch Logsにエラー詳細を出力

#### 3.3.4 LINE APIエラー
- Reply Message送信失敗時、3回までリトライ
- リトライ失敗時、CloudWatch Logsにエラーを出力

## 4. 受け入れ条件

### AC-001: 地域設定の成功
- [ ] ユーザーが市区町村名（例: "渋谷区"）を送信したとき、Geocoding APIで緯度経度を取得できる
- [ ] 取得した緯度経度とユーザーIDをDynamoDBに保存できる
- [ ] 保存成功後、確認メッセージ「{cityName}の天気をお届けします」が返信される

### AC-002: 地域設定の上書き更新
- [ ] 既に設定済みのユーザーが再度地域を設定した場合、データが上書き更新される
- [ ] updatedAtフィールドが現在時刻に更新される

### AC-003: 無効な地域名の処理
- [ ] 存在しない地域名（例: "あああ"）を送信した場合、エラーメッセージが返信される
- [ ] エラーメッセージに正しい入力例が含まれている

### AC-004: 署名検証
- [ ] X-Line-Signatureヘッダが不正なリクエストは401 Unauthorizedで拒否される
- [ ] 正しい署名のリクエストは正常に処理される

### AC-005: リトライ処理
- [ ] Geocoding APIのタイムアウト時、指数バックオフでリトライされる
- [ ] DynamoDB保存失敗時、指数バックオフでリトライされる
- [ ] リトライ回数は最大3回である

### AC-006: ログ出力
- [ ] リクエスト受信時、ユーザーIDと送信メッセージがログに出力される
- [ ] 地域設定成功時、保存したデータがログに出力される
- [ ] エラー発生時、エラー詳細がログに出力される

## 5. 制約事項

### 5.1 技術的制約
- LINE Messaging APIの仕様に準拠する
- OpenWeatherMap Geocoding APIの無料枠（1,000回/日）を考慮
- Lambda関数のタイムアウトは30秒以内
- DynamoDBはオンデマンドキャパシティモードを使用

### 5.2 セキュリティ制約
- LINE Webhookの署名検証は必須
- 全通信はHTTPS
- シークレット情報（LINE Channel Secret、API Key）はAWS Secrets Managerから取得

### 5.3 運用制約
- CloudWatch Logsへのログ出力は必須
- エラー発生時はログレベルERRORで出力

## 6. 対象外（スコープ外）

以下は今回の実装範囲に含まれない:
- 設定確認機能（別タスク）
- 天気配信機能（別タスク）
- 複数地域の登録
- 配信時刻のカスタマイズ
