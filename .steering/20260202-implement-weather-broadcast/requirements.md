# 要求仕様書 - 天気配信機能の実装

## 1. 変更・追加する機能の説明

### 1.1 概要
EventBridgeにより毎日9:00（JST）に自動的にトリガーされ、DynamoDBに登録されている全ユーザーに対して、各ユーザーが設定した地域の「実質天気情報」をLINE Push Messageで配信する機能を実装する。

### 1.2 実質天気情報とは
- **対象時間帯**: 9:00〜23:00（人間の行動時間帯）
- **実質最高気温**: 対象時間帯における最高気温
- **実質最低気温**: 対象時間帯における最低気温
- **実質降水確率**: 対象時間帯における降水確率の最大値

### 1.3 配信フロー
1. EventBridgeにより9:00（JST）にLambda関数をトリガー
2. DynamoDBから全ユーザー情報を取得
3. 緯度経度でユーザーをグルーピング（同じ地域のユーザーは1回のAPI呼び出しで天気情報を取得）
4. OpenWeatherMap One Call API 3.0で各地域の天気情報を取得
5. 取得した時間ごとの天気情報から9:00〜23:00の実質天気を算出
6. 各ユーザーにLINE Push Messageで配信

## 2. ユーザーストーリー

### US-003: 天気情報の受信（再掲）
```
ユーザーとして、
毎朝9時に設定した地域の天気情報を受け取りたい。
なぜなら、その日の服装や持ち物を決める参考にしたいから。
```

## 3. 受け入れ条件

### AC-001: 定時実行
- [ ] EventBridgeにより毎日9:00（JST）に配信処理が開始される
- [ ] cron式は UTC 0:00 = JST 9:00 に設定される

### AC-002: ユーザー取得
- [ ] DynamoDBから地域設定済みの全ユーザーを取得できる
- [ ] Scan操作で全ユーザーを取得する

### AC-003: API呼び出し最適化
- [ ] 緯度経度が同じユーザーをグルーピングする
- [ ] 同じ緯度経度に対しては1回のみOpenWeatherMap APIを呼び出す
- [ ] API呼び出し回数を最小化する

### AC-004: 天気情報取得
- [ ] OpenWeatherMap One Call API 3.0を使用する
- [ ] 緯度経度を指定して時間ごとの天気情報（hourly）を取得する
- [ ] 取得するデータ: dt（Unix timestamp）、temp（気温）、pop（降水確率）

### AC-005: 実質天気算出
- [ ] hourlyデータから9:00〜23:00（JST）のデータを抽出する
- [ ] 実質最高気温 = 抽出データのtempの最大値
- [ ] 実質最低気温 = 抽出データのtempの最小値
- [ ] 実質降水確率 = 抽出データのpopの最大値 × 100（パーセント表示）

### AC-006: メッセージ配信
- [ ] LINE Push Message APIを使用して各ユーザーに配信する
- [ ] 配信メッセージは以下の形式とする:
```
【{cityName}の天気】
最高気温: {maxTemp}℃
最低気温: {minTemp}℃
降水確率: {pop}%
```
- [ ] 全ユーザーへの配信が9:30までに完了する

### AC-007: エラーハンドリング
- [ ] OpenWeatherMap API呼び出し失敗時は3回までリトライする（指数バックオフ: 1秒、2秒、4秒）
- [ ] LINE API呼び出し失敗時は3回までリトライする（指数バックオフ: 1秒、2秒、4秒）
- [ ] API呼び出し失敗時は該当ユーザーをスキップし、ログに記録する
- [ ] 配信処理全体が失敗した場合でも、処理済みユーザーの記録は残す

### AC-008: ログ出力
- [ ] 配信開始時刻と終了時刻をログに出力する
- [ ] 配信対象ユーザー数をログに出力する
- [ ] 配信成功件数と失敗件数をログに出力する
- [ ] エラー発生時は詳細なエラー情報をログに出力する

## 4. 制約事項

### 4.1 技術的制約
- OpenWeatherMap API無料枠: 1,000回/日
- LINE Messaging API無料枠: 200通/月（ライトプラン: 5,000通/月）
- Lambda関数タイムアウト: 300秒（5分）
- Lambda関数メモリ: 512MB

### 4.2 運用上の制約
- 全ユーザーへの配信は9:00〜9:30の間に完了する必要がある
- API呼び出し回数を最小化するため、緯度経度でグルーピングする
- 配信失敗時は個別にスキップし、処理を継続する

### 4.3 データ制約
- タイムゾーン: すべての時刻はJST（Asia/Tokyo）で処理する
- Unix timestampはUTCで提供されるため、JSTに変換して処理する
- 気温は小数点第1位まで表示する
- 降水確率は整数で表示する（小数点以下切り捨て）

## 5. 非機能要件

### 5.1 性能
- 全ユーザーへの配信完了時間: 30分以内
- Lambda関数実行時間: 5分以内

### 5.2 可用性
- 配信処理の成功率: 99%以上
- API呼び出しエラー時のリトライ機能

### 5.3 保守性
- CloudWatch Logsによる詳細なログ出力
- エラー発生時のトレーサビリティ確保

### 5.4 セキュリティ
- LINE Channel Access TokenはAWS Secrets Managerから取得
- OpenWeatherMap API KeyはAWS Secrets Managerから取得
